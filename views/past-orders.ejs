<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Past Orders - Store</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .order-card {
      border: 1px solid #dee2e6;
      border-radius: 8px;
      margin-bottom: 1.5rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .order-header {
      padding: 1rem;
      border-radius: 8px 8px 0 0;
      color: white;
    }
    .store-order-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    .restaurant-order-header {
      background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 50%, #fecfef 100%);
    }
    .ticket-order-header {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }
    .mixed-order-header {
      background: linear-gradient(135deg, #667eea 0%, #ff9a9e 50%, #f093fb 100%);
    }
    .order-body {
      padding: 1rem;
    }
    .item-row {
      border-bottom: 1px solid #f1f3f4;
      padding: 0.75rem 0;
    }
    .item-row:last-child {
      border-bottom: none;
    }
    .order-summary {
      background-color: #f8f9fa;
      padding: 1rem;
      border-radius: 0 0 8px 8px;
      border-top: 1px solid #dee2e6;
    }
    .calculation-breakdown {
      background-color: #e9ecef;
      border: 1px solid #dee2e6;
      margin-top: 1rem;
      padding: 1rem;
      border-radius: 4px;
    }
    .order-type-badge {
      font-size: 0.8rem;
      padding: 0.25rem 0.5rem;
    }
    .event-details {
      background-color: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      padding: 0.75rem;
      margin-bottom: 0.5rem;
    }
    .event-details h6 {
      color: #212529 !important;
    }
    .event-details small {
      color: #495057;
    }
    .section-divider {
      border-top: 2px solid #dee2e6;
      margin: 1rem 0;
      padding-top: 1rem;
    }
    .no-orders {
      text-align: center;
      padding: 3rem;
      color: #6c757d;
    }
  </style>
</head>
<body>
  <%- include('partials/Membernav', { member: member }) %>
  
  <div class="container mt-4">
    <div class="row">
      <div class="col-12">
        <h2 class="mb-4"> Your Order History</h2>
        
        <% if (orders.length === 0) { %>
          <div class="no-orders">
            <h4>No orders yet</h4>
            <p>You haven't placed any orders yet. Start shopping to see your order history here!</p>
            <div class="d-flex gap-2 justify-content-center">
              <a href="/store-items" class="btn btn-primary"> Browse Store</a>
              <a href="/restaurant" class="btn btn-success"> Order Food</a>
              <a href="/events" class="btn btn-outline-primary"> Browse Events</a>
            </div>
          </div>
        <% } else { %>
          <div class="row">
            <div class="col-md-8">
              <% orders.forEach(order => { %>
                <div class="order-card">
                  <div class="order-header <%= 
                    order.orderType === 'store' ? 'store-order-header' : 
                    (order.orderType === 'restaurant' ? 'restaurant-order-header' :
                    (order.orderType === 'ticket' ? 'ticket-order-header' : 'mixed-order-header')) 
                  %>">
                    <div class="row">
                      <div class="col-md-6">
                        <div class="d-flex align-items-center">
                          <h5 class="mb-1">
                            <% 
                              const headerHasStore = order.storeItems && order.storeItems.length > 0;
                              const headerHasRestaurant = order.restaurantItems && order.restaurantItems.length > 0;
                              const headerHasTickets = order.tickets && order.tickets.length > 0;
                              
                              let icons = '';
                              if (headerHasStore) icons += 'üõçÔ∏è';
                              if (headerHasRestaurant) icons += 'üçΩÔ∏è';
                              if (headerHasTickets) icons += 'üé´';
                              
                              if (icons === '') icons = 'üì¶';
                            %>
                            <%= icons %> Order #<%= order.orderId %>
                          </h5>
                          <span class="badge bg-light text-dark order-type-badge ms-2">
                            <%= order.orderTypeLabel %>
                          </span>
                        </div>
                        <small style="color: rgba(255,255,255,0.8)">
                          <%= new Date(order.PurchaseDate).toLocaleDateString('en-US', { 
                            year: 'numeric', 
                            month: 'long', 
                            day: 'numeric'
                          }) %>
                        </small>
                      </div>
                      <div class="col-md-6 text-end">
                        <h4 class="mb-1">$<%= parseFloat(order.FinalAmountPaid).toFixed(2) %></h4>
                        <small style="color: rgba(255,255,255,0.8)">Amount Paid</small>
                        
                        <% if (parseFloat(order.CashbackUsed || 0) > 0) { %>
                          <div style="color: rgba(255,255,255,0.9); margin-top: 0.25rem;">
                            <small> Saved $<%= parseFloat(order.CashbackUsed).toFixed(2) %> with cashback</small>
                          </div>
                        <% } %>
                      </div>
                    </div>
                  </div>
                  
                  <div class="order-body">
                    <!-- Store Items Section -->
                    <% if (order.storeItems && order.storeItems.length > 0) { %>
                      <h6 class="mb-3"> Store Items:</h6>
                      <% order.storeItems.forEach(item => { %>
                        <div class="item-row">
                          <div class="row align-items-center">
                            <div class="col-md-2">
                              <% if (item.storeitempic) { %>
                                <img src="/images/<%= item.storeitempic %>" alt="<%= item.Name %>" 
                                     style="width: 50px; height: 50px; object-fit: cover; border-radius: 4px;">
                              <% } else { %>
                                <div style="width: 50px; height: 50px; background-color: #f8f9fa; border-radius: 4px; display: flex; align-items: center; justify-content: center;">
                                  
                                </div>
                              <% } %>
                            </div>
                            <div class="col-md-6">
                              <strong><%= item.Name %></strong>
                              <% if (!item.is_active) { %>
                                <br><small class="text-muted">(No longer available)</small>
                              <% } %>
                            </div>
                            <div class="col-md-2 text-center">
                              Qty: <%= item.Quantity %>
                            </div>
                            <div class="col-md-2 text-center">
                              $<%= item.Price.toFixed(2) %> each
                            </div>
                          </div>
                        </div>
                      <% }) %>
                    <% } %>

                    <!-- Restaurant Items Section -->
                    <% if (order.restaurantItems && order.restaurantItems.length > 0) { %>
                      <h6 class="mb-3">üçΩÔ∏è Restaurant Items:</h6>
                      <% order.restaurantItems.forEach(item => { %>
                        <div class="item-row">
                          <div class="row align-items-center">
                            <div class="col-md-2">
                              <% if (item.Image) { %>
                                <img src="<%= item.Image %>" alt="<%= item.Name %>" 
                                     style="width: 50px; height: 50px; object-fit: cover; border-radius: 4px;">
                              <% } else { %>
                                <div style="width: 50px; height: 50px; background-color: #f8f9fa; border-radius: 4px; display: flex; align-items: center; justify-content: center;">
                                  üçΩÔ∏è
                                </div>
                              <% } %>
                            </div>
                            <div class="col-md-6">
                              <strong><%= item.Name %></strong>
                              <% if (item.Description) { %>
                                <br><small style="color: #e9ecef;"><%= item.Description %></small>
                              <% } %>
                            </div>
                            <div class="col-md-2 text-center">
                              Qty: <%= item.quantity %>
                            </div>
                            <div class="col-md-2 text-center">
                              $<%= parseFloat(item.Price || 0).toFixed(2) %> each
                            </div>
                          </div>
                        </div>
                      <% }) %>
                    <% } %>
                    
                    <!-- Section Divider for Mixed Orders -->
                    <% 
                      const dividerHasStoreItems = order.storeItems && order.storeItems.length > 0;
                      const dividerHasRestaurantItems = order.restaurantItems && order.restaurantItems.length > 0;
                      const dividerHasTickets = order.tickets && order.tickets.length > 0;
                      const showDivider = ((dividerHasStoreItems || dividerHasRestaurantItems) && dividerHasTickets);
                    %>
                    <% if (showDivider) { %>
                      <div class="section-divider"></div>
                    <% } %>
                    
                    <!-- Event Tickets Section -->
                    <% if (order.tickets && order.tickets.length > 0) { %>
                      <h6 class="mb-3">üé´ Event Tickets:</h6>
                      
                      <%
                    // Group tickets by event WITHIN THIS ORDER ONLY
                    const groupedTickets = {};
                    order.tickets.forEach(ticket => {
                      const eventKey = ticket.Fk_EventID || ticket.EventID;
                      if (!groupedTickets[eventKey]) {
                        groupedTickets[eventKey] = {
                          ...ticket,
                          quantity: 0,
                          totalPrice: 0
                        };
                      }
                      groupedTickets[eventKey].quantity += 1;
                      //  CHANGE THIS LINE:
                      groupedTickets[eventKey].totalPrice += parseFloat(ticket.TotalAmount || 0);
                    });
                    
                    const uniqueEvents = Object.values(groupedTickets);
                  %>
                      
                      <% uniqueEvents.forEach(ticketGroup => { %>
                        <div class="event-details">
                          <div class="row">
                            <div class="col-md-8">
                              <h6 class="mb-2">
                                <%= ticketGroup.Title %>
                              </h6>
                              <div class="row">
                                <div class="col-md-6">
                                  <small>
                                    <strong> Date:</strong> 
                                    <% if (ticketGroup.EventDate) { %>
                                      <%= new Date(ticketGroup.EventDate).toLocaleDateString('en-US', { 
                                        year: 'numeric', 
                                        month: 'short', 
                                        day: 'numeric' 
                                      }) %>
                                    <% } else { %>
                                      Date TBD
                                    <% } %>
                                  </small>
                                </div>
                                <div class="col-md-6">
                                  <small>
                                    <strong> Location:</strong> <%= ticketGroup.Location %>
                                  </small>
                                </div>
                              </div>
                              <div class="mt-1">
                                <small>
                                  <strong> Type:</strong> <%= ticketGroup.EventType %>
                                </small>
                              </div>
                            </div>
                            <div class="col-md-4 text-end">
                              <span class="badge bg-success mb-2">
                                 <%= ticketGroup.quantity %> Ticket<%= ticketGroup.quantity > 1 ? 's' : '' %>
                              </span>
                              <div>
                                <strong style="color: #495057;">
                                  $<%= ticketGroup.totalPrice.toFixed(2) %> total
                                </strong>
                                <br>
                                <small class="text-muted">
                                  $<%= (ticketGroup.totalPrice / ticketGroup.quantity).toFixed(2) %> each
                                </small>
                              </div>
                            </div>
                          </div>
                        </div>
                      <% }) %>
                    <% } %>
                    
                    <!-- Order Calculation Breakdown -->
                    <%
                      const totalAmount = parseFloat(order.TotalAmount);
                      const cashbackUsed = parseFloat(order.CashbackUsed || 0);
                      const finalAmountPaid = parseFloat(order.FinalAmountPaid);
                      const discountAmount = totalAmount - cashbackUsed - finalAmountPaid;
                      const discountPercentage = totalAmount > 0 ? ((discountAmount / totalAmount) * 100) : 0;
                    %>
                    
                    <div class="calculation-breakdown">
                      <div class="row">
                        <div class="col-md-8">
                          <strong style="color: #495057;">Order Summary:</strong>
                        </div>
                        <div class="col-md-4 text-end">
                          <div class="mb-1" style="color: #6c757d;">
                            Original Total: $<%= totalAmount.toFixed(2) %>
                          </div>
                          
                          <% if (discountAmount > 0) { %>
                            <div class="mb-1" style="color: #dc3545; font-weight: 500;">
                              Discount (<%= discountPercentage.toFixed(0) %>%): -$<%= discountAmount.toFixed(2) %>
                            </div>
                            <div class="mb-1" style="color: #6c757d;">
                              After Discount: $<%= (totalAmount - discountAmount).toFixed(2) %>
                            </div>
                          <% } %>
                          
                          <% if (cashbackUsed > 0) { %>
                            <div class="mb-1" style="color: #28a745; font-weight: 500;">
                              Cashback Applied: -$<%= cashbackUsed.toFixed(2) %>
                            </div>
                          <% } %>
                          
                          <div class="border-top pt-2" style="border-color: #6c757d !important;">
                            <strong style="color: #007bff; font-size: 1.1em;">
                              Amount Paid: $<%= finalAmountPaid.toFixed(2) %>
                            </strong>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              <% }) %>
            </div>
            
            <div class="col-md-4">
              <div class="card">
                <div class="card-header">
                  <h6 class="mb-0"> Order Summary</h6>
                </div>
                <div class="card-body">
                  <%
                    const summaryStoreOrders = orders.filter(o => o.storeItems.length > 0);
                    const summaryRestaurantOrders = orders.filter(o => o.restaurantItems && o.restaurantItems.length > 0);
                    const summaryTicketOrders = orders.filter(o => o.tickets.length > 0);
                    const summaryMixedOrders = orders.filter(o => 
                      (o.storeItems.length > 0 ? 1 : 0) + 
                      (o.restaurantItems && o.restaurantItems.length > 0 ? 1 : 0) + 
                      (o.tickets.length > 0 ? 1 : 0) > 1
                    );
                    const totalSpent = orders.reduce((sum, order) => sum + parseFloat(order.FinalAmountPaid), 0);
                    const totalCashbackUsed = orders.reduce((sum, order) => sum + parseFloat(order.CashbackUsed || 0), 0);
                    const totalTickets = orders.reduce((sum, order) => sum + order.tickets.length, 0);
                    const totalItems = orders.reduce((sum, order) => sum + order.storeItems.reduce((itemSum, item) => itemSum + item.Quantity, 0), 0);
                    const totalRestaurantItems = orders.reduce((sum, order) => 
                      sum + (order.restaurantItems ? order.restaurantItems.reduce((itemSum, item) => itemSum + item.quantity, 0) : 0), 0
                    );
                  %>
                  
                  <div class="mb-3">
                    <strong>Total Orders:</strong> <%= orders.length %>
                    <br>
                    <small class="text-muted">
                      <% if (summaryMixedOrders.length > 0) { %>
                       <%= summaryMixedOrders.length %> mixed ‚Ä¢ 
                      <% } %>
                      <% if (summaryStoreOrders.length - summaryMixedOrders.length > 0) { %>
                         <%= summaryStoreOrders.length - summaryMixedOrders.length %> store ‚Ä¢ 
                      <% } %>
                      <% if (summaryRestaurantOrders.length - summaryMixedOrders.length > 0) { %>
                         <%= summaryRestaurantOrders.length - summaryMixedOrders.length %> restaurant ‚Ä¢ 
                      <% } %>
                      <% if (summaryTicketOrders.length - summaryMixedOrders.length > 0) { %>
                         <%= summaryTicketOrders.length - summaryMixedOrders.length %> tickets
                      <% } %>
                    </small>
                  </div>
                  
                  <% if (totalItems > 0) { %>
                    <div class="mb-3">
                      <strong> Total Store Items:</strong> <%= totalItems %>
                    </div>
                  <% } %>
                  
                  <% if (totalRestaurantItems > 0) { %>
                    <div class="mb-3">
                      <strong> Total Food Items:</strong> <%= totalRestaurantItems %>
                    </div>
                  <% } %>
                  
                  <% if (totalTickets > 0) { %>
                    <div class="mb-3">
                      <strong> Total Tickets:</strong> <%= totalTickets %>
                    </div>
                  <% } %>
                  
                  <div class="mb-3">
                    <strong> Total Spent:</strong> 
                    $<%= totalSpent.toFixed(2) %>
                  </div>
                  
                  <% if (totalCashbackUsed > 0) { %>
                    <div class="mb-3 text-success">
                      <strong> Cashback Used:</strong> 
                      $<%= totalCashbackUsed.toFixed(2) %>
                    </div>
                  <% } %>
                  
                  <hr>
                  
                  <div class="d-grid gap-2">
                    <a href="/store-items" class="btn btn-primary"> Continue Shopping</a>
                    <a href="/restaurant" class="btn btn-success"> Order Food</a>
                    <a href="/events" class="btn btn-outline-primary"> Browse Events</a>
                  </div>
                </div>
              </div>
            </div>
          </div>
        <% } %>
      </div>
    </div>
  </div>

</body>
</html>