<!--Sanjana -->
<!DOCTYPE html>
<html lang="en">  
<head>
  <meta charset="UTF-8" />
  <title>Manage Members</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">



  <style>
    div.scrollable-table::-webkit-scrollbar {
      width: 8px;
    }
    div.scrollable-table::-webkit-scrollbar-thumb {
      background-color: rgba(0,0,0,0.2);
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <%- include('partials/Adminnav.ejs') %>

  <div class="container mt-4" style="max-width: 1200px;">
    <h2 class="mb-3">Manage Members</h2>

    <% if (typeof error !== 'undefined' && error) { %>
      <div class="alert alert-danger"><%= error %></div>
    <% } %>

    <!-- Search Form -->
    <form method="GET" action="/admin/members" class="mb-4 d-flex gap-2">
      <input type="text" name="q" class="form-control" placeholder="Search..." value="<%= keyword %>">
      <button type="submit" class="btn btn-primary">Search</button>
    </form>

    <% if (!editingMember) { %>
      <h4 class="mb-3">Add New Member</h4>
      <form action="/admin/members" method="POST" class="row g-3 mb-5">
        <input type="hidden" name="mode" value="add">
        <div class="col-md-4">
          <input type="text" name="fullName" class="form-control" placeholder="Full Name" required>
        </div>
        <div class="col-md-4">
          <input type="email" name="email" class="form-control" placeholder="Email" required>
        </div>
        <div class="col-md-4">
          <input type="password" name="password" class="form-control" placeholder="Password" required>
        </div>
        <div class="col-md-4">
          <input type="text" name="phone" class="form-control" placeholder="Phone" required>
        </div>
        <div class="col-md-4">
          <select name="tierId" class="form-select" required>
            <option value="" disabled selected>Choose Tier</option>
            <% tiers.forEach(t => { %>
              <option value="<%= t.TierID %>"><%= t.TierName %></option>
            <% }) %>
          </select>
        </div>
        <div class="col-md-4">
          <input type="date" name="expiryDate" class="form-control" required>
        </div>
        <div class="col-12">
          <button type="submit" class="btn btn-success">Add Member</button>
        </div>
      </form>
    <% } else { %>
      <h4 class="mb-3">Edit Member</h4>
      <form action="/admin/members" method="POST" class="row g-3 mb-5">
        <input type="hidden" name="mode" value="edit">
        <input type="hidden" name="memberId" value="<%= editingMember.MemberID %>">
        <div class="col-md-4">
          <input type="text" name="fullName" class="form-control" placeholder="Full Name" required value="<%= editingMember.Member_FullName %>">
        </div>
        <div class="col-md-4">
          <input type="email" name="email" class="form-control" placeholder="Email" required value="<%= editingMember.Member_Email %>">
        </div>
        <div class="col-md-4">
          <input type="password" name="password" class="form-control" placeholder="Password (leave blank to keep current)">
        </div>
        <div class="col-md-4">
          <input type="text" name="phone" class="form-control" placeholder="Phone" required value="<%= editingMember.Member_Phone %>">
        </div>
        <div class="col-md-4">
          <select name="tierId" class="form-select" required>
            <option value="" disabled>Choose Tier</option>
            <% tiers.forEach(t => { %>
              <option value="<%= t.TierID %>" <%= editingMember.Fk_TierID === t.TierID ? 'selected' : '' %>><%= t.TierName %></option>
            <% }) %>
          </select>
        </div>
        <div class="col-md-4">
          <input type="date" name="expiryDate" class="form-control" required value="<%= editingMember.ExpiryDate ? editingMember.ExpiryDate.toISOString().split('T')[0] : '' %>">
        </div>
        <div class="col-12">
          <button type="submit" class="btn btn-success">Update Member</button>
          <a href="/admin/members" class="btn btn-secondary ms-2">Cancel</a>
        </div>
      </form>
    <% } %>

    <div class="scrollable-table" style="max-height: 500px; overflow-y: auto; border: 1px solid #ddd; border-radius: 8px; padding: 15px; background: white;">
      <table class="table table-striped table-hover mb-0">
        <thead class="table-dark sticky-top">
          <tr>
            <th>Name</th>
            <th>Email</th>
            <th>Phone</th>
            <th>Tier</th>
            <th>Cashback</th>
            <th>Cashback Expiry</th>
            <th>Expiry</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <% members.forEach(m => { %>
            <tr>
              <td><%= m.Member_FullName %></td>
              <td><%= m.Member_Email %></td>
              <td><%= m.Member_Phone %></td>
              <td><%= m.TierName %></td>
              <td>$<%= (m.CashbackBalance || 0).toFixed(2) %></td>
             <td><%= m.Cashback_ExpiryDate ? m.Cashback_ExpiryDate.toLocaleDateString('en-CA') : 'No Cashback Yet' %></td>
              <td><%= m.ExpiryDate ? m.ExpiryDate.toISOString().split('T')[0] : 'N/A' %></td>
              <td class="d-flex gap-1">
                <button type="button" class="btn btn-info btn-sm" onclick="toggleCashback('<%= m.MemberID %>')">View</button>
                <a href="/admin/members/edit/<%= m.MemberID %>" class="btn btn-warning btn-sm">Edit</a>
                <form action="/admin/member/delete/<%= m.MemberID %>" method="POST" onsubmit="return confirm('Delete this member?')" style="display:inline;">
                  <button type="submit" class="btn btn-danger btn-sm">Delete</button>
                </form>
              </td>
            </tr>
            <tr id="cashback-<%= m.MemberID %>" style="display: none;">
              <td colspan="8">
                <div class="bg-light p-3 rounded border">
                  <strong>Cashback History for <%= m.Member_FullName %>:</strong>
                  <div id="cashback-container-<%= m.MemberID %>">Loading...</div>
                </div>
              </td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    </div>
  </div>

  <script> // this script toggles the visibility of cashback history i use AI to help me write this code
    function toggleCashback(memberId) {
      const row = document.getElementById('cashback-' + memberId);
      const container = document.getElementById('cashback-container-' + memberId);
      row.style.display = row.style.display === 'none' ? '' : 'none';

      if (container.innerHTML === 'Loading...') {
        fetch(`/admin/member/${memberId}/cashback`)
          .then(res => res.json())
          .then(data => {
            // Filter out cashback with 0 or less amount
            const filteredData = data.filter(c => c.Amount > 0);

            if (!filteredData || filteredData.length === 0) {
              container.innerHTML = `
                <table class="table table-sm mt-2">
                  <thead>
                    <tr><th>Amount</th><th>Earned From</th><th>Earned</th><th>Expires</th></tr>
                  </thead>
                  <tbody>
                    <tr><td colspan="4" class="text-center text-muted">No cashback history available.</td></tr>
                  </tbody>
                </table>
              `;
            } else {
              let html = '<table class="table table-sm mt-2"><thead><tr><th>Amount</th><th>Earned From</th><th>Earned</th><th>Expires</th></tr></thead><tbody>';
              filteredData.forEach(c => {
                const amount = parseFloat(c.Amount ?? 0).toFixed(2);
                const earned = new Date(c.EarnedDate).toLocaleDateString('en-CA');
                const expires = new Date(c.Cashback_ExpiryDate).toLocaleDateString('en-CA');

                html += `<tr>
                  <td>$${amount}</td>
                  <td>${c.EarnedFrom}</td>
                  <td>${earned}</td>
                  <td>${expires}</td>
                </tr>`;
              });
              html += '</tbody></table>';
              container.innerHTML = html;
            }
          })
          .catch(err => {
            container.innerHTML = '<p class="text-danger">Error loading cashback data.</p>';
            console.error(err);
          });
      }
    }
  </script>
</body>
</html>
