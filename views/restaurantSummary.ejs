<!DOCTYPE html>
<html>
<head>
  <title>Payment Summary</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
  <style>
    body { background-color: #0c0f18; color: white; }
    .summary-box {
      background-color: #1c1f2e;
      padding: 30px;
      border-radius: 10px;
      margin-top: 50px;
    }
  </style>
</head>
<body>
  <%- include('partials/Membernav', { member: member }) %>

  <div class="container summary-box">
    <h1 class="text-warning text-center mb-4">Restaurant Payment Summary</h1>

    <table class="table table-dark table-bordered">
      <thead>
        <tr>
          <th>Item</th>
          <th>Quantity</th>
          <th>Price</th>
          <th>Subtotal</th>
        </tr>
      </thead>
      <tbody>
        <% items.forEach(item => { %>
          <tr>
            <td><%= item.Name %></td>
            <td><%= item.quantity %></td>
            <td>$<%= parseFloat(item.Price || 0).toFixed(2) %></td>
            <td>$<%= item.itemTotal.toFixed(2) %></td>
          </tr>
        <% }) %>
      </tbody>
    </table>

    <hr>

    <p><strong>Total Before Discount:</strong> $<%= total.toFixed(2) %></p>
    <p><strong>Membership Tier Discount (<%= discountPercentage %>%):</strong> -$<%= discountAmount.toFixed(2) %></p>
    <p><strong>Cashback Used:</strong> -$<%= cashbackUsed.toFixed(2) %></p>
    <p class="text-success fs-5"><strong>Final Amount to Pay:</strong> $<%= finalAmount.toFixed(2) %></p>

    <div class="text-center mt-4">
      <button id="checkout-button" class="btn btn-success btn-lg">Pay Now</button>
    </div>

<script>
  // Get data from server
  const total = parseFloat(<%= total %>);
  const cashbackUsed = parseFloat(<%= cashbackUsed %>);
  const finalAmount = parseFloat(<%= finalAmount.toFixed(2) %>);
  const discountAmount = parseFloat(<%= discountAmount %>);

  // Get items data from server
  const rawItems = <%- JSON.stringify(items) %>;

  // Format items for Stripe
  const formattedItems = rawItems.map(item => {
    const totalAmount = parseFloat(item.Price);
    const originalSubtotal = totalAmount * item.quantity;
    const discountShare = (originalSubtotal / total) * discountAmount;
    const discountedTotal = originalSubtotal - discountShare;
    const unitPrice = discountedTotal / item.quantity;

    return {
      name: item.Name,
      amount: Math.round(unitPrice * 100), // Stripe expects cents
      quantity: item.quantity,
      Name: item.Name,
      Price: totalAmount,
      Image: item.Image,
      ItemID: item.ItemID
    };
  });

  // Handle checkout button click
  window.onload = function () {
    document.getElementById('checkout-button').addEventListener('click', function () {
      console.log("Pay Now clicked");

      // First save the bill to database
      fetch('/restaurant/checkout', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
          items: formattedItems, 
          total: total, 
          cashbackUsed: cashbackUsed, 
          finalAmount: finalAmount 
        })
      })
      .then(res => {
        if (!res.ok) throw new Error('Failed to save bill');
        
        // Then create Stripe checkout session
        return fetch('/create-checkout-session', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ items: formattedItems })
        });
      })
      .then(res => res.json())
      .then(data => {
        if (data.url) {
          window.location.href = data.url;
        } else {
          throw new Error('Stripe session failed');
        }
      })
      .catch(error => {
        console.error("Checkout failed:", error);
        alert('Checkout failed: ' + error.message);
      });
    });
  };
</script>

  </div>
</body>
</html>