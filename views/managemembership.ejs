<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Manage Membership</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
  <style>
    body {
      background-color: #0c0f18;
      color: white;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    .container {
      margin-top: 50px;
      max-width: 600px;
    }
    .membership-tier {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      border: 1px solid white;
      margin-bottom: 10px;
      background-color: #1a1d29;
    }
    .selected {
      background-color: #28a745 !important;
      color: white !important;
      border: none;
    }
    .current-tier {
      background-color: #17a2b8 !important;
      color: white !important;
      border: none;
    }
    .select-btn {
      border-radius: 6px;
      padding: 5px 15px;
      background-color: #f49b00;
      color: white;
      border: none;
    }
    .select-btn:hover:not(:disabled) {
      background-color: #d88700;
    }
    .select-btn:disabled {
      background-color: #666;
      cursor: not-allowed;
      opacity: 0.6;
    }
    .checkout-btn {
      display: block;
      margin: 30px auto;
      padding: 10px 25px;
      font-size: 16px;
      background-color: #f49b00;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      color: white;
    }
    .checkout-btn:hover:not(:disabled) {
      background-color: #d88700;
    }
    .checkout-btn:disabled {
      background-color: #666;
      cursor: not-allowed;
      opacity: 0.6;
    }
    .current-tier-indicator {
      font-size: 12px;
      color: #17a2b8;
      font-weight: bold;
    }
    .tier-description {
      color: #b8c6db !important;
      font-size: 13px;
      line-height: 1.4;
      margin-top: 4px;
      font-weight: 400;
    }
  </style>
</head>
<body>
  <%- include('partials/Membernav.ejs') %>

  <div class="container">
    <h2 class="text-center">Manage Membership</h2>
    <p class="text-center"><strong>Current Tier:</strong> <span id="current-tier-display"><%= currentTier %></span></p>

    <% const tiers = [
         { 
           name: 'Gold', 
           price: '$9.99', 
           description: '$9.99 per month. Perks: 5% off AND 5% cashback on ALL purchases! Also gain EXCLUSIVE access to the premium lounge inside the club!' 
         },
         { 
           name: 'Silver', 
           price: '$4.99', 
           description: '$4.99 per month. Perks: 3% off AND 3% cashback on ALL purchases!' 
         },
         { 
           name: 'Bronze', 
           price: 'Free', 
           description: 'Free Base tier. UPGRADE to enjoy EXCLUSIVE PERKS!' 
         }
       ]; %>
    <% tiers.forEach(tier => { %>
      <div class="membership-tier">
        <div>
          <span><%= tier.name %></span>
          <small class="tier-description d-block"><%= tier.description %></small>
          <% if (tier.name === currentTier) { %>
            <small class="current-tier-indicator">Your Current Tier</small>
          <% } %>
        </div>
        <button 
          type="button" 
          class="select-btn <% if (tier.name === currentTier) { %>current-tier<% } %>" 
          data-tier="<%= tier.name %>" 
          data-is-current="<%= tier.name === currentTier ? 'true' : 'false' %>">
          <% if (tier.name === currentTier) { %>Current<% } else { %>Select<% } %>
        </button>
      </div>
    <% }) %>

    <button id="checkout-button" class="checkout-btn" disabled>Select a Different Tier</button>
  </div>

  <script>
    const buttons = document.querySelectorAll('.select-btn');
    const checkoutBtn = document.getElementById('checkout-button');
    const currentTier = '<%= currentTier %>';
    let selectedTier = null;

    console.log('Current tier:', currentTier);

    // Update checkout button text and state based on selected tier
    function updateCheckoutButton(tier) {
      if (!tier || tier === currentTier) {
        // No tier selected or current tier selected
        checkoutBtn.textContent = tier === currentTier ? 'Already Your Current Tier' : 'Select a Different Tier';
        checkoutBtn.disabled = true;
        checkoutBtn.classList.add('disabled');
      } else if (tier === 'Bronze') {
        checkoutBtn.textContent = 'Downgrade to Bronze (Free)';
        checkoutBtn.disabled = false;
        checkoutBtn.classList.remove('disabled');
      } else {
        checkoutBtn.textContent = `Upgrade to ${tier}`;
        checkoutBtn.disabled = false;
        checkoutBtn.classList.remove('disabled');
      }
    }

    // Initialize the checkout button state
    updateCheckoutButton(currentTier);

    buttons.forEach(button => {
      button.addEventListener('click', function () {
        const tier = this.dataset.tier;
        const isCurrent = this.dataset.isCurrent === 'true';

        console.log('Clicked tier:', tier, 'Is current:', isCurrent);

        // If clicking current tier, don't allow selection
        if (isCurrent) {
          console.log('Cannot select current tier');
          return;
        }

        // Store selection on server
        fetch('/member/managemembership/select', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ tier })
        })
        .then(res => {
          if (!res.ok) throw new Error('Failed to select tier');
          
          // Update UI state
          selectedTier = tier;
          
          // Reset all buttons to default state
          buttons.forEach(btn => {
            const btnTier = btn.dataset.tier;
            const btnIsCurrent = btn.dataset.isCurrent === 'true';
            
            // Remove selected class from all
            btn.classList.remove('selected');
            
            if (btnIsCurrent) {
              // Keep current tier button as "Current"
              btn.textContent = 'Current';
              btn.classList.add('current-tier');
              btn.disabled = true;
            } else if (btnTier === tier) {
              // Mark selected tier
              btn.classList.add('selected');
              btn.textContent = 'Selected';
              btn.disabled = false;
            } else {
              // Other tiers show "Select"
              btn.textContent = 'Select';
              btn.disabled = false;
              btn.classList.remove('current-tier');
            }
          });

          // Update checkout button
          updateCheckoutButton(tier);
        })
        .catch(err => {
          console.error('Failed to select tier:', err);
          alert('Failed to select tier. Please try again.');
        });
      });
    });

    // Handle checkout (payment or free downgrade)
    checkoutBtn.addEventListener('click', function() {
      if (this.disabled) return;
      
      console.log("Checkout clicked for tier:", selectedTier);
      
      // Prevent clicking current tier
      if (selectedTier === currentTier) {
        console.log('Cannot checkout for current tier');
        return;
      }
      
      checkoutBtn.disabled = true;
      checkoutBtn.textContent = 'Processing...';

      fetch('/member/managemembership/create-checkout-session', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      })
      .then(res => res.json())
      .then(data => {
        if (data.redirect) {
          // Free tier - redirect directly
          window.location.href = data.redirect;
        } else if (data.url) {
          // Paid tier - go to Stripe
          window.location.href = data.url;
        } else {
          throw new Error('No checkout URL received');
        }
      })
      .catch(error => {
        console.error("Checkout failed:", error);
        alert('Processing failed: ' + error.message);
        checkoutBtn.disabled = false;
        updateCheckoutButton(selectedTier);
      });
    });
  </script>

</body>
</html>